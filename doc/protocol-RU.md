# Протокол клиент-серверного взаимодействия в игре Кассандра

## Номер версии

Номер версии протокола, описанного в данном документе — 1.

## Общее для всех методов

Если метод добавляет/изменяет/удаляет данные на сервере только POST
(singup/score)
Если метод требователен к безопасности только POST (signin/signout)
Если метод только читает данные тогда GET
Поле "status" пересекается с (http статусами)[https://ru.wikipedia.org/wiki/Список_кодов_состояния_HTTP]

* 200 — OK
* 400 — Bad Request — Ошибка запроса
* 401 — Unauthorized — Необходима авторизация
* 404 — Not Found — Данные не найдены
* 405 — Method Not Allowed — Пришли с GET на метод требующий POST
* 500 — Internal Server Error — Ошибка сервера
* 501 — Not Implemented — Метод не реализован
и т.д.

В случае не правильного заполнения необходимых полей, метод возвращает статус 400 и в body содержится информация об ошибках в формате:
```javascript
{
  status: 400,
  body: {
    "name": {
      /* Тип ошибки */
      "error": "required",
      /* Значение, которое валидировал сервер */
      "value": ""
    },
    "password": {
      /* Тип ошибки */
      "error": "badvalue",
      /* Значение, которое валидировал сервер */
      /* Если кто-то отдаст пароль, будет писать юнит тесты на модели для проверки отсутствия пароля в ответах сервера ;-) */
      "value": ""
    }
  }
}
```

## Регистрация

    /api/v<НОМЕР_ВЕРСИИ>/auth/signup

Принимает только POST запросы

### Пример POST-запроса

```javascript
{
    name: String,
    email: String,
    password: String
}
```

#### Успешная регистрация

Код ответа: 200

```javascript
{
    status: 200,
    body: {
        id: 2,
        name: "Vasya",
        email: "vasya@mail.ru",
        password: ""
    }
}
```

## Авторизация

    /api/v<НОМЕР_ВЕРСИИ>/auth/signin

### Пример POST-запроса

```javascript
{
    email: String,
    password: String
}
```

#### Успешная авторизация

Код ответа: 200

```javascript
{
    status: 200,
    body: {
        id: 2,
        name: "Vasya",
        email: "vasya@mail.ru",
        password: "",
        score: 100500
    }
}
```

## Проверка авторизации и игрового состояния

    /api/v<НОМЕР_ВЕРСИИ>/auth/check

### Пример GET-запроса

    Без параметров

Ответ сервера будет зависеть от того, в каком игровом состоянии находится пользователь:

#### Ещё не выбрал свою команду

Код ответа: 200

```javascript
{
    status: 200,
    body: {
        id: 2,
        name: "Vasya",
        email: "vasya@mail.ru",
        score: 100500,
        team: null
    }
}
```

#### Играет в некоторой команде

Код ответа: 200

```javascript
{
    status: 200,
    body: {
        id: 2
        name: "Vasya",
        email: "vasya@mail.ru",
        score: 100500,
        team: 13
    }
}
```

#### Пользователь не залогинен

Код ответа: 401

```javascript
{
    status: 401,
    body: {}
}
```

## Сброс авторизации

    /api/v<НОМЕР_ВЕРСИИ>/auth/signout

### Пример POST-запроса

    Без параметров.

Ответ сервера будет зависеть от авторизованности пользователя:

#### Пользователь залогинен

Код ответа: 200

```javascript
{
    status: 200,
    body: {}
}
```

#### Пользователь не залогинен

Код ответа: 401

```javascript
{
    status: 401,
    body: {}
}
```

## Игровая статистика

    /api/v<НОМЕР_ВЕРСИИ>/scores

### Пример GET-запроса

```javascript
{
    sort: {
      by: "date",
      order: "asc"
    }
}
```

Ответ сервера будет зависеть от авторизованности пользователя:

#### Пользователь залогинен

Код ответа: 200
    
    ```javascript
    {
        status: 200,
        body: {}
    }
    ```

#### Пользователь не залогинен

Код ответа: 401

```javascript
{
    status: 401,
    body: {}
}
```

## Игра

Во время игры пользователь подключается по протоколу WebSocket по нижеследующему адресу.

    /api/v<НОМЕР_ВЕРСИИ>/game

Ответ сервера будет зависеть от текущего состояния клиентской сессии.

### Пользователь не залогинен

Код ответа: 401

```javascript
{
    status: 401,
    body: {}
}
```

### Пользователь залогинен

Устанавливается WebSocket-соединение. Напомним, что WebSocket'ы допускают полнодуплексную отправку сообщений как клиентом, так и сервером.

#### Сервер: «Вы — Наблюдатель»

В случае, если пользователь не может присоединиться к какой-либо команде, он может наблюдать за ходом чьей-либо чужой игры. В этом случае будем называть его *Наблюдателем* (viewer).

```javascript
{
  type: "viewer_status",
  body: {
    artist: {},
    cassandra: {},
    judges: [
      {}, {}
    ],
    secret: "Cow",
    viewers: [
      {}, {}
    ]
  }
}
```

#### Сервер: «Вы — игрок»

В случае, если пользователя «только и дожидалось» трое человек, формируется новая команда, участником которой он немедленно становится (команды формируются из четвёрок пользователей).

```javascript
{
  type: "player_status",
  body: {
    artist: {}, // Не указывается, если role === "artist"
    cassandra: {}, // Не указывается, если role === "cassandra"
    judges: [
      {}, {} // Указывается только один судья, если role === "judge"
    ],
    role: "cassandra", // или "judge", или "artist"
    secret: "Cow" // Не указывается, если role === "cassandra"
  }
}
```

#### Сервер: «Пользователь отключился»

В случае, если один из игроков команды, за которой наблюдает или в которой участвует клиент, покинул игру или один из наблюдателей покинул игру, сервер посылает клиенту это сообщение.

```javascript
{
  type: "user_gone",
  body: {
    id: 13
  }
}
```

#### Сервер: «Пользователь подключился»

В случае, если на сайт зашёл ещё один Наблюдатель, но пока общее количество Наблюдателей меньше четырёх, сервер посылает клиенту это сообщение.

```javascript
{
  type: "user_come",
  body: {
    id: 13,
    name: "Steve",
    score: 100500
  }
}
```

#### Сервер: «Пользователь печатает сообщение в чате»

```javascript
{
  type: "chat_typing",
  body: {
    id: 13 // id пользователя, который печатает
  }
}
```

#### Сервер: «Пользователь закончил печатать сообщение в чате»

```javascript
{
  type: "chat_stopped_typing",
  body: {
    id: 13 // id пользователя, который закончил печатать
  }
}
```

#### Сервер: «Новое сообщение в чате»

```javascript
{
  type: "chat_message",
  body: {
    id: 13, // id автора сообщения
    text: "Hello, everybody!"
  }
}
```

#### Сервер: «Кассандра печатает догадку (guess)»

```javascript
{
  type: "guess_typing",
  body: {}
}
```

#### Сервер: «Кассандра закончила печатать догадку»

```javascript
{
  type: "guess_stopped_typing",
  body: {}
}
```

#### Сервер: «Новое состояние догадки Кассандры»

Эти сообщения получают Судьи и Наблюдатели — все, кроме Кассандры и Художника, по мере того, как Кассандра вводит догадку. Они нужны для того, чтобы прибавить игре драматизма, заставив игроков следить за муками Кассандры.

```javascript
{
  type: "guess_status",
  body: {
    text: "bull"
  }
}
```

#### Сервер: «Художник печатает подсказку»

```javascript
{
  type: "prompt_typing",
  body: {}
}
```

#### Сервер: «Художник закончил печатать догадку»

```javascript
{
  type: "prompt_stopped_typing",
  body: {}
}
```

#### Сервер: «Новое состояние подсказки Художника»

Эти сообщения получают Кассандра, Судьи и Наблюдатели — все, кроме Художника, по мере того, как Художник вводит подсказку Кассандре.

```javascript
{
  type: "prompt_status",
  body: {
    text: "a milky animal with horns"
  }
}
```
