# Протокол клиент-серверного взаимодействия в игре Кассандра

## Номер версии

Номер версии протокола, описанного в данном документе — 1.

## Общее для всех методов

Если метод добавляет/изменяет/удаляет данные на сервере только POST
(singup/score)
Если метод требователен к безопасности только POST (signin/signout)
Если метод только читает данные тогда GET
Поле "status" пересекается с (http статусами)[https://ru.wikipedia.org/wiki/Список_кодов_состояния_HTTP]

* 200 — OK
* 400 — Bad Request — Ошибка запроса
* 401 — Unauthorized — Необходима авторизация
* 404 — Not Found — Данные не найдены
* 405 — Method Not Allowed — Пришли с GET на метод требующий POST
* 500 — Internal Server Error — Ошибка сервера
* 501 — Not Implemented — Метод не реализован
и т.д.

В случае не правильного заполнения необходимых полей, метод возвращает статус 400 и в body содержится информация об ошибках в формате:
```javascript
{
  status: 400,
  body: {
    "name": {
      /* Тип ошибки */
      "error": "required",
      /* Значение, которое валидировал сервер */
      "value": ""
    },
    "password": {
      /* Тип ошибки */
      "error": "badvalue",
      /* Значение, которое валидировал сервер */
      /* Если кто-то отдаст пароль, будет писать юнит тесты на модели для проверки отсутствия пароля в ответах сервера ;-) */
      "value": ""
    }
  }
}
```

## Регистрация

    /api/v<НОМЕР_ВЕРСИИ>/auth/signup

Принимает только POST запросы

### Пример POST-запроса

```javascript
{
    name: String,
    email: String,
    password: String
}
```

#### Успешная регистрация

Код ответа: 200

```javascript
{
    status: 200,
    body: {
        id: 2,
        name: "Vasya",
        email: "vasya@mail.ru",
        password: ""
    }
}
```

## Авторизация

    /api/v<НОМЕР_ВЕРСИИ>/auth/signin

### Пример POST-запроса

```javascript
{
    email: String,
    password: String
}
```

#### Успешная авторизация

Код ответа: 200

```javascript
{
    status: 200,
    body: {
        id: 2,
        name: "Vasya",
        email: "vasya@mail.ru",
        password: "",
        score: 100500
    }
}
```

## Проверка авторизации и игрового состояния

    /api/v<НОМЕР_ВЕРСИИ>/auth/check

### Пример GET-запроса

    Без параметров

Ответ сервера будет зависеть от того, в каком игровом состоянии находится пользователь:

#### Ещё не выбрал свою команду

Код ответа: 200

```javascript
{
    status: 200,
    body: {
        id: 2,
        name: "Vasya",
        email: "vasya@mail.ru",
        score: 100500,
        team: null
    }
}
```

#### Играет в некоторой команде

Код ответа: 200

```javascript
{
    status: 200,
    body: {
        id: 2
        name: "Vasya",
        email: "vasya@mail.ru",
        score: 100500,
        team: 13
    }
}
```

#### Пользователь не залогинен

Код ответа: 401

```javascript
{
    status: 401,
    body: {}
}
```

## Сброс авторизации

    /api/v<НОМЕР_ВЕРСИИ>/auth/signout

### Пример POST-запроса

    Без параметров.

Ответ сервера будет зависеть от авторизованности пользователя:

#### Пользователь залогинен

Код ответа: 200

```javascript
{
    status: 200,
    body: {}
}
```

#### Пользователь не залогинен

Код ответа: 401

```javascript
{
    status: 401,
    body: {}
}
```

## Игровая статистика

    /api/v<НОМЕР_ВЕРСИИ>/scores

### Пример GET-запроса

```javascript
{
    sort: {
      by: "date",
      order: "asc"
    }
}
```

Ответ сервера будет зависеть от авторизованности пользователя:

#### Пользователь залогинен

Код ответа: 200
    
    ```javascript
    {
        status: 200,
        body: {}
    }
    ```

#### Пользователь не залогинен

Код ответа: 401

```javascript
{
    status: 401,
    body: {}
}
```

## Игра

Во время игры пользователь подключается по протоколу WebSocket по нижеследующему адресу.

    /api/v<НОМЕР_ВЕРСИИ>/game

Ответ сервера будет зависеть от текущего состояния клиентской сессии.

### Пользователь не залогинен

Код ответа: 401

```javascript
{
    status: 401,
    body: {}
}
```

### Пользователь залогинен

Устанавливается WebSocket-соединение. Напомним, что WebSocket'ы допускают полнодуплексную отправку сообщений как клиентом, так и сервером.

#### Сообщение сервера: "Вы подключены"

1. В случае, если пользователь не может присоединиться к какой-либо команде, он может наблюдать за ходом чьей-либо чужой игры.

    ```javascript
    {
      status: "connected_as_viewer",
      body: {
        artist: {},
        cassandra: {},
        judges: [
          {}, {}
        ],
        secret: "Cow"
      }
    }
    ```

1. В случае, если пользователя только и дожидалось трое человек, формируется новая команда, участником которой он немедленно становится.

    ```javascript
    {
      status: "connected_as_player",
      body: {
        artist: {},
        cassandra: {},
        judges: [
          {}, {}
        ],
        role: "cassandra", // "judge" или "artist"
        secret: "Cow"
      }
    }
    ```
